---
title: Principios de creación de paquetes en R
author: Martín Macías
date: '2018-04-02'
slug: principios-de-creación-de-paquetes-en-r
categories: []
tags: []
draft: FALSE
---

La motivación de crear paquetes en R nace a partir de la necesidad de reunir en un solo lugar, funciones que sean útiles para tareas específicas. Dos ejemplos claros son los paquetes [`broman`](https://github.com/kbroman/broman) y [`Hmisc`](github.com/harrelfe/Hmisc) de Karl Broman y Frank Harrell, respectivamente. Estos dos paquetes contienen funciones que esos dos estadísticos han utilizado en el desarrollo de sus proyectos.

Como lo dije en un anterior [post,](http://martin.rbind.io/post/2018/03/22/introducción-a-la-creación-de-paquetes-en-r/) inicialmente voy a basarme en el blog _Not so standard deviations_ [Writing an R package from scratch](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/) de Hilary Parker. Luego, usaré información del blog de Matthew James Denny [R Package Pictorial](http://www.mjdenny.com/R_Package_Pictorial.html).

Existen dos caminos para crear un paquete en R. El primero es "a pedal", es decir, utilizando las funciones de las librerías `devtools` y `roxygen2` y el segundo es con la ayuda de RStudio.

## Primer camino

Para este camino, se supone que usted no maneja cómodamente RStudio y, por ende, no sabe crear proyectos, ni mucho menos paquetes.

### Paso 0: Paquetes necesarios

Los paquetes necesarios para crear un paquete en R son `devtools` y `roxygen2`. Aquí se recomienda que descargue la versión en desarrollo de `roxygen2`.

```
install.packages("devtools")
library("devtools")
devtools::install_github("klutometis/roxygen")
library(roxygen2)
```

### Paso 1: Crear un directorio para su paquete

Cree un directorio donde almacenará la información de su paquete. Ese directorio no debe estar dentro de un proyecto de RStudio. 

```
setwd("ruta_del_directorio_donde_guarda_sus_funciones")
create("paqueteR")
```

cuya salida debería ser similar a:

```
Creating package 'paqueteR' in '/Users/martin/funciones'
No DESCRIPTION found. Creating with values:


Package: paqueteR
Title: What the Package Does (one line, title case)
Version: 0.0.0.9000
Authors@R: person("First", "Last", email = "first.last@example.com", role = c("aut", "cre"))
Description: What the package does (one paragraph).
Depends: R (>= 3.4.3)
License: What license is it under?
Encoding: UTF-8
LazyData: true
* Creating `martinR.Rproj` from template.
* Adding `.Rproj.user`, `.Rhistory`, `.RData` to ./.gitignore
```

Si busca en su directorio principal, ahora tendrá una carpeta llamada paqueteR, y dentro de ella tendrá una carpeta llamada R, un archivo llamado DESCRIPTION, otro llamado NAMESPACE y un proyecto llamado paqueteR.Rproj. Puede editar el archivo DESCRIPTION para incluir toda su información de contacto, etc.

### Paso 2: Agregue funciones

Si está leyendo esto, probablemente tenga funciones para las que quiso crear un paquete. Copie esas funciones en su carpeta R. 

### Paso 3: Agregue documentación 

El paquete roxygen2 hace que todo sea increíble, simple y sencillo. La forma en que funciona es que agrega comentarios especiales al comienzo de cada función, que luego se compilarán en el formato correcto para la [documentación del paquete](https://github.com/klutometis/roxygen#roxygen2). Los detalles se pueden encontrar en la documentación de roxygen2; solo proporcionaré un ejemplo para nuestra función.

Los comentarios que debe agregar al principio de la función son, por ejemplo, los siguientes:

```
#' Una función que limpia una cadena de caracteres, removiendo puntuación y números y tokenizándola
#' 
#' @param str Una cadena de caracteres de entrada tal como "This is a cool function!" 
#' @return Un vector que contiene todos los tokens válidos de la cadena de caracteres de entrada original
#' @export
```

Quizás sea conveniente crear un nuevo archivo para cada función, pero si prefiere simplemente puede crear nuevas funciones secuencialmente en un archivo, solo asegúrese de agregar los comentarios de la documentación antes de cada función.

### Paso 4: Procese su documentación

Ahora necesita crear la documentación de sus anotaciones antes. Ya ha realizado el trabajo "difícil" en el Paso 3. El paso 4 es tan fácil al hacer esto:

```
setwd("./paqueteR")
document()
```

cuya salida debería ser similar a esto:

```
Updating paqueteR documentation
Loading paqueteR
Updating roxygen version in /Users/martin/funciones/paqueteR/DESCRIPTION
Writing NAMESPACE
```

Esto agrega automáticamente los archivos `.Rd` al directorio `man, y actualiza el archivo NAMESPACE en el directorio principal. Puede leer más sobre [esto](http://r-pkgs.had.co.nz/description.html), pero en términos de pasos a seguir, realmente no tiene que hacer nada más.

### Paso 5: Instalación

¡Ahora es tan simple como instalar el paquete! Debe ejecutar esto desde el directorio de trabajo principal que contiene la carpeta `paqueteR`.

```
setwd("..")
install("paqueteR")
```

cuya salida sería más o menos así:

```
Installing paqueteR
'/Library/Frameworks/R.framework/Resources/bin/R' --no-site-file  \
  --no-environ --no-save --no-restore --quiet CMD INSTALL  \
  '/Users/martin/funciones/paqueteR'  \
  --library='/Library/Frameworks/R.framework/Versions/3.4/Resources/library'  \
  --install-tests 

* installing *source* package ‘paqueteR’ ...
** R
** preparing package for lazy loading
** help
No man pages found in package  ‘paqueteR’ 
*** installing help indices
** building package indices
** testing if installed package can be loaded
* DONE (paqueteR)
Reloading installed paqueteR
```

Ahora tiene un paquete en R real, en vivo y funcionando. Por ejemplo, intente escribir ?Clean_String. Debería ver aparecer la página de ayuda estándar.

### Paso 6: Haga que el paquete sea un repositorio de GitHub

El beneficio de poner el paquete en Github es que puede usar la función `install_github()` para instalar su nuevo paquete directamente desde la página de Github.

## Segundo camino

### Paso 0: Cree un repositorio en Github 

Conviene crear un repositorio en Github con el mismo nombre del paquete que se creará en RStudio. Cuando se cree, es mejor que no inicialice el repositorio con README.

### Paso 1: Creando un paquete en RStudio

Para crear paquetes en RStudio, es conveniente revisar este [tutorial.](https://support.rstudio.com/hc/en-us/articles/200486488-Developing-Packages-with-RStudio).

Seleccione `New Project...`, luego `New Directory`, después `R Package`. Una vez esté allí, necesitará escribir el nombre de su paquete y seleccionar un directorio para alojar su proyecto. Podría, también, manualmente escoger algunos archivos en R que contengan las funciones que desee incluir dentro de su paquete. Igualmente, debería resaltar el cuadro de diálogo para crear un repositorio de Git.

Luego agregue las funciones que desee que tenga su paquete. Finalmente haga **Commit** a toda esta información, agregue un mensaje al Commit y haga **Push** para que el paquete quede alojado en su repositorio de Github. 

### Paso 2: Documente su paquete

Ahora puee editar la información del archivo `DESCRIPTION` y diligenciar los campos con texto informativo sobre su paquete. Piense en algo similar a esto:

```
Package: cleanStringR
Type: Package
Title: Un paquete de ejemplo que hace tal cosa
Version: 0.0.1
Date: 2018-04-06
Author: Daniel Rodríguez <peluche_rosadito@gmail.com>
Maintainer: Martín Macías <martinandresmacias@gmail.com>
Description: Provee funciones para limpiar cadenas
License: GPL2
LazyData: TRUE
```

Luego, querrá asegurarse de documentar adecuadamente todas las funciones que desee que sean visibles para los usuarios del paquete (se describe en detalle a continuación). Luego podrá usar la función `devtools::document()` para generar automáticamente archivos de ayuda para cada una de estas funciones y la función `devtools::use_package()` para crear una dependencia en `DESCRIPTION` entre su paquete y otro del cual se tenga referencia.

```
devtools::use_package("stringr")
devtools::document()
```

Fíjese en el archivo `DESCRIPTION` y verá que se añadió la línea `RoxygenNote: 6.0.1` que confirma la documentación de su paquete.

### Paso 3: Construya e instale el paquete

Ahora puede avanzar y hacer clic en la pestaña **Build** en RStudio y luego en el botón **Install and Restart** en esta pestaña y R creará su paquete y lo cargará en su sistema.

Note que se han agregado más archivos al directorio del paquete (los archivos de ayuda para sus funciones).

Ahora debería poder acceder a su paquete en su equipo local utilizando el comando estándar `library(mypackage)`. El siguiente paso es subir su paquete actualizado a Github. Si todo salió bien, otras personas podrán descargar e instalar su paquete instalando primero `devtools` y luego ejecutando el siguiente comando:

```
devtools::install_github("suUsernameEnGithub/NombredelPaquete")
```

## Dependiencias

Si las funciones que queremos utilizar requieren acceso a otros paquetes, podemos asegurarnos de que se agreguen como dependencias (que se descargarán automáticamente con el paquete) ejecutando la siguiente línea de código para cada paquete que deseemos requerir (con el nombre del paquete apropiado insertado):

```
devtools::use_package("stringr")
```

Tenga en cuenta que la mejor manera de acceder a la funcionalidad que proporcionan estos paquetes es hacer referencia explícita a sus subfunciones cuando las necesitemos en lugar de cargar todo el paquete como se muestra en el siguiente ejemplo:

```
stringr::str_replace_all(temp,"[^a-zA-Z\s]", " ")
```

Esto puede parecer tedioso al principio, pero terminará reduciendo conflictos y haciendo su vida más fácil a largo plazo. Es posible que también desee asegurarse de que sus usuarios tengan instalada una versión más nueva de R. Puede hacer esto agregando la siguiente línea a su archivo `DESCRIPTION`

```
Depends: R (>= 3.0.1)
```

Aquí hay un ejemplo de las importaciones y dependencias en el archivo DESCRIPTION para uno de los paquetes en los que uno puede estar trabajando:

```
Imports:
        Rcpp,
        RcppArmadillo,
        BH,
        ggplot2,
        methods,
LinkingTo:
        BH,
        Rcpp,
        RcppArmadillo
Depends:
        R (>= 3.0.1)
```

## Datos de ejemplo

A menudo será útil agregar datos de ejemplo a su paquete, ya que esto permitirá a los usuarios asegurarse de que entienden el formato que desean sus funciones y cuál debería ser su resultado. Afortunadamente, esto es bastante fácil, ya que el paquete devtools proporciona una función para agregar datos a su paquete y garantizar que esté en el formato correcto. Lo primero que debe hacer es cargar todos los objetos de datos que desea incluir con el paquete en su sesión R. Cada objeto debe tener el nombre que desea que tenga cuando el usuario lo vea, y cada objeto se almacenará como un archivo `.rda` con el mismo nombre en el directorio `./data`. A continuación, puede agregar los datos mediante el siguiente comando:

```
devtools::use_data(mis_datos_1,mis_datos_2, mis_datos_3)
```

Puede incluir tantos objetos como desee, pero probablemente sea una buena idea no incluir grandes conjuntos de datos, ya que esto hará que la instalación de su paquete sea realmente lenta. Una vez que haya ejecutado las líneas de código anteriores, puede ir al directorio y verificar que todo esté en el lugar correcto. 

